const mongojs = require('mongojs');

module.exports = function (dbnames, dburl = "test", domain) {

  var dbs = mongojs(dburl, dbnames);
  function bind(domain) {
    domain.on({
      type: "create"
    }, function (event) {
      let {
        actorType,
        data
      } = event;

      let db = dbs[actorType];
      if (db) {
        db.save(data);
      }
    });

    domain.on({
      type: "remove"
    }, function (event) {

      const {
        actorType,
        actorId
      } = event;
      let db = dbs[actorType];
      if (db) {
        db.remove({
          id: actorId
        });
      }
    });

    domain.on({}, function (event) {
      const {
        actorType,
        updatedData,
        type,
        actorId
      } = event;
      if (!(type === "remove" || type === "create")) {
        let db = dbs[actorType];
        if (db) {
          db.update({
            id: actorId
          }, {
              $set: updatedData
            });
        }
      }
    });
  }

  if (domain) bind(domain);

  return {
    dbs, bind
  };
}
